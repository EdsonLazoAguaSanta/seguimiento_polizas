{% extends "base.html" %}

{% block title %}Bancos · Gestión de Seguros Agua Santa{% endblock %}

{% block content %}
<h1>Clasificación para bancos</h1>

<form method="post" action="/bancos">

    <!-- Bloque: correos nuevos desde carpeta Bancos en Outlook -->
    {% if mails_bancos and subcarpetas_polizas %}
        <h2>Correos nuevos (carpeta Outlook "Bancos")</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Remitente</th>
                    <th>Asunto</th>
                    <th>Subcarpeta de pólizas</th>
                </tr>
            </thead>
            <tbody>
                {% for mail in mails_bancos %}
                    <tr>
                        <td>{{ mail.fecha }}</td>
                        <td>{{ mail.remitente }}</td>
                        <td>{{ mail.asunto }}</td>
                        <td>
                            <!-- id del mail -->
                            <input type="hidden" name="mail_id" value="{{ mail.id }}">
                            <!-- selector de subcarpeta destino -->
                            <select name="mail_carpeta" class="form-select form-select-sm">
                                <option value="">-- Seleccionar --</option>
                                {% for carpeta in subcarpetas_polizas %}
                                    <option value="{{ carpeta }}">{{ carpeta }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <hr>
    {% endif %}

    <!-- Bloque: pólizas (PDF) + correos ya clasificados por subcarpeta -->
    {% if carpetas %}
        {% for carpeta, archivos in carpetas.items() %}
            <details open>
                <summary>
                    {{ carpeta }} ({{ archivos|length }} póliza{{ 's' if archivos|length != 1 }})
                </summary>
                <ul>
                    {% for doc in archivos %}
                        <li>
                            <label>
                                <input
                                    type="checkbox"
                                    name="seleccion"
                                    value="{{ doc.rel_path }}"
                                    {% if doc.rel_path in polizas_benef_banco %}checked{% endif %}
                                >
                                Beneficiario banco
                            </label>
                            &nbsp;|&nbsp;
                            <a href="/polizas/view/{{ doc.rel_path }}" target="_blank">
                                {{ doc.nombre }}
                            </a>
                            – {{ doc.mtime }}
                        </li>
                    {% endfor %}

                    <!-- Correos clasificados en esta subcarpeta -->
                    {% if correos_bancos_clasificados.get(carpeta) %}
                        {% for mail in correos_bancos_clasificados[carpeta] %}
                            <li>
                                <strong>[MAIL]</strong>
                                {{ mail.fecha }} – {{ mail.remitente }} – {{ mail.asunto }}
                            </li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </details>
        {% endfor %}
    {% else %}
        <p>No se encontraron pólizas para bancos con los filtros actuales.</p>
    {% endif %}

    <button type="submit" class="btn btn-primary">Guardar clasificación</button>
</form>
{% endblock %}
